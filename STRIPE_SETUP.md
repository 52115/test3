# Stripe決済機能のセットアップガイド

## Stripeとは

Stripeは、オンライン決済を簡単に実装できる決済サービスです。このアプリケーションでは、カード支払い機能にStripeを使用しています。

## テストモードと本番モード

Stripeには2つのモードがあります：

### テストモード（開発・テスト用）
- **実際のお金は動きません**
- テスト用のカード番号を使用できます
- 無料で使用できます
- キーは `pk_test_...` と `sk_test_...` で始まります

### 本番モード（実際のサービス用）
- **実際のお金が動きます**
- 本物のカード情報が必要です
- 手数料がかかります（通常2.9% + 30円）
- キーは `pk_live_...` と `sk_live_...` で始まります

**開発中は必ずテストモードを使用してください！**

## セットアップ手順

### 1. Stripeアカウントの作成

1. [Stripe公式サイト](https://stripe.com/jp)にアクセス
2. 「アカウントを作成」をクリック
3. メールアドレスとパスワードでアカウントを作成
4. メール認証を完了

### 2. テストキーの取得

1. [Stripeダッシュボード](https://dashboard.stripe.com/)にログイン
2. 左上の「テストモード」スイッチが**ON**になっていることを確認（重要！）
3. 左メニューから「開発者」→「API キー」を選択
4. 以下の2つのキーをコピー：
   - **公開可能キー**（`pk_test_...`で始まる）
   - **シークレットキー**（`sk_test_...`で始まる）※「表示」をクリックして表示

### 3. .envファイルの設定

`src/.env`ファイルに以下のように設定します：

```env
STRIPE_KEY=pk_test_51AbCdEfGhIjKlMnOpQrStUvWxYz1234567890
STRIPE_SECRET=sk_test_51AbCdEfGhIjKlMnOpQrStUvWxYz1234567890
```

**重要：**
- 実際のキーをコピーして貼り付けてください
- キーは他人に共有しないでください
- `.env`ファイルはGitにコミットしないでください（`.gitignore`に含まれています）

### 4. アプリケーションの再起動

設定を反映するために、Dockerコンテナを再起動してください：

```bash
docker-compose restart php
```

## テストカードの使い方

テストモードでは、以下のテストカード番号を使用できます：

### 成功するカード（推奨）
```
カード番号: 4242 4242 4242 4242
有効期限: 任意の未来の日付（例: 12/34）
CVC: 任意の3桁（例: 123）
郵便番号: 任意の5桁（例: 12345）
```

### 3Dセキュア認証が必要なカード
```
カード番号: 4000 0025 0000 3155
有効期限: 任意の未来の日付
CVC: 任意の3桁
郵便番号: 任意の5桁
```
※このカードを使用すると、3Dセキュア認証画面が表示されます

### 決済が拒否されるカード（エラーテスト用）
```
カード番号: 4000 0000 0000 0002
有効期限: 任意の未来の日付
CVC: 任意の3桁
郵便番号: 任意の5桁
```
※このカードを使用すると、決済が拒否されます

## 使い方

### 1. 商品購入画面にアクセス

1. アプリケーションにログイン
2. 商品詳細ページから「購入する」をクリック
3. 購入画面が表示されます

### 2. カード支払いを選択

1. 「支払い方法」で「カード支払い」を選択
2. カード入力欄が自動的に表示されます

### 3. テストカード情報を入力

1. カード番号: `4242 4242 4242 4242`
2. 有効期限: 任意の未来の日付（例: `12/34`）
3. CVC: 任意の3桁（例: `123`）
4. 郵便番号: 任意の5桁（例: `12345`）

### 4. 購入を完了

1. 「購入する」ボタンをクリック
2. 決済が処理されます（テストモードなので実際のお金は動きません）
3. 購入完了画面にリダイレクトされます

## トラブルシューティング

### カード入力欄が表示されない

- `.env`ファイルに`STRIPE_KEY`が正しく設定されているか確認
- ブラウザのコンソールでエラーを確認（F12キー）
- Stripeのキーが`pk_test_...`で始まっているか確認

### 決済が失敗する

- テストモードのキーを使用しているか確認
- カード番号が正しいか確認（`4242 4242 4242 4242`など）
- ブラウザのコンソールでエラーメッセージを確認

### エラーメッセージが表示される

- Stripeダッシュボードの「ログ」を確認
- `.env`ファイルの`STRIPE_SECRET`が正しく設定されているか確認
- アプリケーションのログを確認（`src/storage/logs/laravel.log`）

## 本番環境への移行

本番環境で使用する場合は：

1. Stripeダッシュボードで「本番モード」に切り替え
2. 本番用のAPIキーを取得（`pk_live_...`と`sk_live_...`）
3. `.env`ファイルを本番用のキーに更新
4. 本番環境の`.env`ファイルに設定

**注意：本番環境では実際のお金が動きます。十分にテストしてから移行してください。**

## 参考リンク

- [Stripe公式ドキュメント（日本語）](https://stripe.com/docs/api?lang=php)
- [Stripeテストカード一覧](https://stripe.com/docs/testing)
- [Stripeダッシュボード](https://dashboard.stripe.com/)

